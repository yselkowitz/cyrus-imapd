#!perl
use Cassandane::Tiny;

sub test_calendar_defaultalerts_no_caldav
    :min_version_3_7 :needs_component_jmap
{
    my ($self) = @_;

    my $jmap = $self->{jmap};
    my $caldav = $self->{caldav};

    xlog "Set default alarms";
    my $res = $jmap->CallMethods([
        ['Calendar/set', {
            update => {
                Default => {
                    defaultAlertsWithTime => {
                        alert1 => {
                            '@type' => 'Alert',
                            trigger => {
                                '@type' => 'OffsetTrigger',
                                relativeTo => 'start',
                                offset => '-PT15M',
                            },
                            action => 'display',
                        }
                    },
                },
            },
        }, 'R1'],
    ]);
    $self->assert(exists $res->[0][1]{updated}{Default});

    xlog $self, "Can not PROPFIND JMAP alerts over DAV";
    my $propfindXml = <<EOF;
<?xml version="1.0" encoding="UTF-8"?>
<D:propfind xmlns:D="DAV:" xmlns:J="urn:ietf:params:jmap:calendars">
  <D:prop>
     <J:defaultalerts-with-time/>
     <J:defaultalerts-without-time/>
  </D:prop>
</D:propfind>
EOF
    $res = $caldav->Request('PROPFIND', "/dav/calendars/user/cassandane/Default",
        $propfindXml, 'Content-Type' => 'text/xml');

    $self->assert_matches(qr/Not Found/, $res->{'{DAV:}response'}[0]{
        '{DAV:}propstat'}[0]{'{DAV:}status'}{content});

    xlog $self, "Can not PROPPATCH JMAP alerts over DAV";
    my $proppatchXml = <<EOF;
<?xml version="1.0" encoding="UTF-8"?>
<D:propertyupdate xmlns:D="DAV:" xmlns:J="urn:ietf:params:jmap:calendars">
  <D:set>
    <D:prop>
<J:defaultalerts-with-time>
BEGIN:VALARM
UID:c5f1c439-d18d-4c98-89e1-211ccf752dec
TRIGGER:-PT5M
ACTION:DISPLAY
DESCRIPTION:alarmTime1
END:VALARM
BEGIN:VALARM
UID:37859148-2801-45bf-bdb8-528d5704788c
TRIGGER:PT0M
ACTION:DISPLAY
DESCRIPTION:alarmTime2
END:VALARM
</J:defaultalerts-with-time>
    </D:prop>
  </D:set>
  <D:set>
    <D:prop>
<J:defaultalerts-without-time>
BEGIN:VALARM
UID:bc0c8431-503e-427a-bb2d-6a1e2fca2d3f
TRIGGER:PT0S
ACTION:DISPLAY
DESCRIPTION:alarmDate1
END:VALARM
</J:defaultalerts-without-time>
    </D:prop>
  </D:set>
</D:propertyupdate>
EOF
    $res = $caldav->Request('PROPPATCH', "/dav/calendars/user/cassandane/Default",
        $proppatchXml, 'Content-Type' => 'text/xml');

    $self->assert_matches(qr/Forbidden/, $res->{'{DAV:}response'}[0]{
        '{DAV:}propstat'}[0]{'{DAV:}status'}{content});
}
